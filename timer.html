<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cool-Dog.eu Agility Timer</title>

    <!-- PWA Meta Tags -->
    <meta name="application-name" content="Agility Timer" />
    <meta
      name="description"
      content="Professional agility timing system with hardware integration"
    />
    <meta name="theme-color" content="#2196F3" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="Agility Timer" />
    <meta name="msapplication-TileColor" content="#2196F3" />
    <meta name="msapplication-tap-highlight" content="no" />

    <!-- Icons -->
    <link rel="icon" type="image/png" href="assets/images/logo.png" />
    <link rel="shortcut icon" type="image/png" href="assets/images/logo.png" />
    <link rel="apple-touch-icon" href="assets/images/logo.png" />
    <link
      rel="apple-touch-icon"
      sizes="152x152"
      href="assets/images/logo.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="assets/images/logo.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="167x167"
      href="assets/images/logo.png"
    />

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json" />
    <link rel="stylesheet" href="assets/css/styles.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
  </head>
  <body>
    <div id="app" v-cloak>
      <header class="app-header">
        <div class="logo-container">
          <img src="assets/images/logo.png" alt="CoolDog" class="logo" />
          <h1>Agility Timer Online v1.8</h1>
        </div>
        <div class="connection-status">
          <button @click="confirmRefresh" class="btn btn-secondary btn-small">
            <i class="material-icons">refresh</i>
            Refresh
          </button>
          <div class="status-group">
            <div class="status-item">
              <span class="status-led" :class="statusLedClass"></span>
              <span>Timer: {{ connectionStatus }}</span>
            </div>
            <div class="status-item">
              <span class="status-led" :class="mledStatusLedClass"></span>
              <span>Display: {{ mledConnectionStatus }}</span>
            </div>
          </div>
          <span v-if="!isOnline" class="offline-indicator">
            <i class="material-icons">cloud_off</i>
            OFFLINE
          </span>
          <button @click="toggleTheme" class="btn btn-secondary btn-small theme-toggle" :title="isDarkMode ? 'Switch to Light Mode' : 'Switch to Dark Mode'">
            <i class="material-icons">{{ isDarkMode ? 'light_mode' : 'dark_mode' }}</i>
          </button>
          <img
            src="assets/images/logo.png"
            alt="CoolDog"
            class="header-logo"
            @click="openWebsite"
          />
        </div>
      </header>

      <!-- Main content wrapper with tabs -->
      <div class="app-content-wrapper">
        <!-- Tabs inside wrapper -->
        <div class="tabs-container">
          <div class="tabs-header">
            <button
              class="tab-button"
              :class="{ active: activeTab === 'timer' }"
              @click="activeTab = 'timer'"
            >
              <i class="material-icons" style="vertical-align: middle; font-size: 20px;">timer</i>
              Timer
            </button>
            <button
              class="tab-button"
              :class="{ active: activeTab === 'display' }"
              @click="activeTab = 'display'"
            >
              <i class="material-icons" style="vertical-align: middle; font-size: 20px;">tv</i>
              Display
            </button>
          </div>
        </div>

        <!-- Timer Tab Content -->
        <main class="main-container tab-content" :class="{ active: activeTab === 'timer' }">
          <div class="timer-content-wrapper">
            <section class="timer-section">
          <div class="section-header">
            <h2>Latest Result</h2>
            <div style="display: flex; gap: 0.5rem;">
              <button
                @click="openPictureInPicture"
                class="btn btn-secondary btn-small"
                title="Open Picture-in-Picture window"
              >
                <i class="material-icons">picture_in_picture_alt</i>
              </button>
              <button
                @click="copyLatestResult"
                class="btn btn-secondary"
                :class="{ 'copy-success': copyButtonEffect === 'latest' }"
              >
                <i class="material-icons"
                  >{{ copyButtonEffect === 'latest' ? 'check' : 'content_copy'
                  }}</i
                >
                {{ copyButtonEffect === 'latest' ? 'Copied!' : 'Copy' }}
              </button>
            </div>
          </div>
          <div
            class="timer-display"
            :class="{ running: isRunning }"
            @dblclick="copyLatestResult"
            title="Double-click to copy"
          >
            <div class="timer-value">{{ displayTime }}</div>
            <div class="timer-status">{{ timerStatus }}</div>
          </div>

          <div class="precision-toggle">
            <label class="checkbox-label">
              <input
                type="checkbox"
                v-model="settings.highPrecisionTime"
                @change="updateDisplayPrecision"
              />
              High Precision (3 decimals)
            </label>
          </div>

          <div class="control-buttons">
            <button
              @click="toggleConnection"
              class="btn"
              :class="{ 'btn-danger': isConnected, 'btn-primary': !isConnected }"
            >
              <i class="material-icons"
                >{{ isConnected ? 'usb_off' : 'usb' }}</i
              >
              {{ isConnected ? 'Disconnect' : 'Connect' }}
            </button>
            <button @click="openSettings" class="btn btn-secondary">
              <i class="material-icons">settings</i>
              Settings
            </button>
            <button @click="openInfo" class="btn btn-secondary">
              <i class="material-icons">info</i>
              Info
            </button>
          </div>
        </section>

        <section class="results-section">
          <div class="section-header">
            <h2>Result History</h2>
            <button
              @click="copySelectedResult"
              class="btn btn-secondary"
              :class="{ 'copy-success': copyButtonEffect === 'selected' }"
              :disabled="!selectedResult"
            >
              <i class="material-icons"
                >{{ copyButtonEffect === 'selected' ? 'check' : 'content_copy'
                }}</i
              >
              {{ copyButtonEffect === 'selected' ? 'Copied!' : 'Copy Selected'
              }}
            </button>
          </div>
          <div class="results-table-container">
            <table class="results-table">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Result</th>
                  <th>Timestamp</th>
                </tr>
              </thead>
              <tbody>
                <tr
                  v-for="(result, index) in results"
                  :key="index"
                  @click="selectResult(index)"
                  @dblclick="copyResultRow(index)"
                  :class="{ selected: selectedResultIndex === index }"
                  title="Click to select, double-click to copy"
                >
                  <td>{{ results.length - index }}</td>
                  <td :class="'result-' + result.status">
                    {{ formatResultDisplay(result) }}
                  </td>
                  <td>{{ result.timestamp }}</td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="results-actions">
            <button
              @click="exportResults"
              class="btn btn-secondary"
              :disabled="results.length === 0"
            >
              <i class="material-icons">download</i>
              Export CSV
            </button>
            <button
              @click="setupJsonExport"
              class="btn btn-secondary"
              :class="{ 'btn-success': jsonFileHandle }"
            >
              <i class="material-icons"
                >{{ jsonFileHandle ? 'check_circle' : 'save' }}</i
              >
              {{ jsonFileHandle ? 'JSON Active' : 'SAVE to JSON' }}
            </button>
            <button
              @click="confirmClearResults"
              class="btn btn-danger"
              :disabled="results.length === 0"
            >
              <i class="material-icons">clear_all</i>
              Clear Results
            </button>
          </div>
        </section>
          </div><!-- Close timer-content-wrapper -->
      </main>

      <!-- Display Tab Content -->
      <div class="mled-container tab-content" :class="{ active: activeTab === 'display' }">
        <!-- Sticky Control Bar -->
        <div class="mled-sticky-controls">
          <div class="mled-preview">
            <div class="mled-preview-row">
              <div class="mled-preview-left" v-html="mledPreviewText"></div>
              <div class="mled-preview-right">Active: {{ mledActiveLabel }}</div>
            </div>
          </div>

          <div class="mled-sticky-controls-row">
            <button @click="toggleMledConnection" class="btn" :class="mledConnected ? 'btn-danger' : 'btn-primary'">
              <i class="material-icons">{{ mledConnected ? 'usb_off' : 'usb' }}</i>
              {{ mledConnected ? 'Disconnect' : 'Connect' }}
            </button>

            <div class="mled-sticky-right-controls">
              <div class="brightness-slider-wrap">
                <span style="color: var(--text-primary);">Brightness</span>
                <div class="brightness-slider" :data-pos="mledBrightness">
                  <div class="brightness-knob"></div>
                  <button @click="setMledBrightness(1)" type="button">1</button>
                  <button @click="setMledBrightness(2)" type="button">2</button>
                  <button @click="setMledBrightness(3)" type="button">3</button>
                </div>
              </div>
              <button @click="clearMled" class="btn btn-secondary">
                <i class="material-icons">clear_all</i>
                Clear
              </button>
            </div>
          </div>
        </div>

        <!-- MLED Text Module -->
        <div class="mled-module" :class="{ disabled: !mledTextEnabled }">
          <div class="module-toggle">
            <label>
              <input type="checkbox" v-model="mledTextEnabled" :disabled="!mledConnected" />
              Enable
            </label>
          </div>
          <div class="module-header">MLED TEXT</div>

          <div style="padding: 1rem;">
            <div style="position: relative; margin-bottom: 1rem;">
              <textarea
                v-model="mledTextInput"
                class="mled-textarea"
                placeholder="max 64 bytes"
                maxlength="64"
                @input="updateMledCharCounter"
              ></textarea>
              <div class="char-counter">{{ mledCharsLeft }} left</div>
            </div>

            <!-- Settings row -->
            <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem;">
              <label class="module-label">Scroll speed</label>
              <div class="mled-radio-group">
                <label><input type="radio" v-model="mledScrollSpeed" value="0" /> 0</label>
                <label><input type="radio" v-model="mledScrollSpeed" value="1" /> 1</label>
                <label><input type="radio" v-model="mledScrollSpeed" value="2" /> 2</label>
                <label><input type="radio" v-model="mledScrollSpeed" value="3" /> 3</label>
              </div>

              <label class="module-label" style="margin-left: 1rem;">Text color</label>
              <select v-model="mledTextColor" class="mled-select">
                <option value="Default">Default</option>
                <option value="Red">Red</option>
                <option value="Green">Green</option>
                <option value="Blue">Blue</option>
                <option value="Yellow">Yellow</option>
                <option value="Magenta">Magenta</option>
                <option value="Cyan">Cyan</option>
                <option value="White">White</option>
                <option value="Orange">Orange</option>
                <option value="Deep pink">Deep pink</option>
                <option value="Light Blue">Light Blue</option>
              </select>
            </div>

            <!-- Buttons row -->
            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
              <button @click="sendMledText" class="btn btn-primary">Send text</button>
            </div>
          </div>
        </div>

        <!-- Coursewalks Module -->
        <div class="mled-module" :class="{ disabled: !mledCwEnabled }">
          <div class="module-toggle">
            <label>
              <input type="checkbox" v-model="mledCwEnabled" :disabled="!mledConnected" />
              Enable
            </label>
          </div>
          <div class="module-header">Coursewalks</div>

          <div style="padding: 1rem;">
            <!-- Settings row -->
            <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem;">
              <label class="module-label">Version</label>
              <select v-model="mledCwVersion" class="mled-select" :disabled="!mledCwEnabled">
                <option value="1">CW1</option>
                <option value="2">CW2</option>
                <option value="3">CW3</option>
                <option value="4">CW4</option>
              </select>

              <label class="module-label" style="margin-left: 1rem;">Duration</label>
              <select v-model="mledCwDuration" class="mled-select" :disabled="!mledCwEnabled">
                <option value="7">7 min</option>
                <option value="8">8 min</option>
                <option value="9">9 min</option>
                <option value="10">10 min</option>
              </select>

              <label class="module-label" style="margin-left: 1rem;">Wait</label>
              <select v-model="mledCwWait" class="mled-select" :disabled="!mledCwEnabled">
                <option value="10">10 s</option>
                <option value="20">20 s</option>
                <option value="30">30 s</option>
              </select>
            </div>

            <!-- Buttons row -->
            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
              <button @click="startCoursewalk" class="btn btn-primary" :disabled="!mledCwEnabled">Start</button>
            </div>
          </div>
        </div>

        <!-- Countdown Timer Module -->
        <div class="mled-module" :class="{ disabled: !mledTimerEnabled }">
          <div class="module-toggle">
            <label>
              <input type="checkbox" v-model="mledTimerEnabled" :disabled="!mledConnected" />
              Enable
            </label>
          </div>
          <div class="module-header">Countdown</div>

          <div style="padding: 1rem;">
            <!-- Count Up Section -->
            <div style="margin-bottom: 1.5rem;">
              <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem;">
                <label class="module-label">Count up</label>
                <label class="module-label" style="margin-left: 1rem;">Color</label>
                <select v-model="mledUpColor" class="mled-select" :disabled="!mledTimerEnabled">
                  <option value="Red">Red</option>
                  <option value="Green">Green</option>
                  <option value="Blue">Blue</option>
                  <option value="Yellow">Yellow</option>
                  <option value="Magenta">Magenta</option>
                  <option value="Cyan">Cyan</option>
                  <option value="White">White</option>
                  <option value="Orange">Orange</option>
                  <option value="Deep pink">Deep pink</option>
                  <option value="Light Blue">Light Blue</option>
                </select>
              </div>
              <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                <button @click="startCountUp" class="btn btn-primary" :disabled="!mledTimerEnabled">Start</button>
                <button @click="stopCountUp" class="btn btn-danger" :disabled="!mledTimerEnabled">Stop</button>
              </div>
            </div>

            <!-- Count Down Section -->
            <div class="module-section-container">
              <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem;">
                <label class="module-label">Count down</label>
                <label class="module-section-label">hh</label>
                <input
                  v-model.number="mledDownHH"
                  type="number"
                  min="0"
                  max="1"
                  style="width: 60px;"
                  class="mled-select"
                  :disabled="!mledTimerEnabled"
                />
                <label class="module-label">mm</label>
                <input
                  v-model.number="mledDownMM"
                  type="number"
                  min="0"
                  max="99"
                  style="width: 70px;"
                  class="mled-select"
                  :disabled="!mledTimerEnabled"
                />
                <label class="module-label">ss</label>
                <input
                  v-model.number="mledDownSS"
                  type="number"
                  min="0"
                  max="59"
                  style="width: 70px;"
                  class="mled-select"
                  :disabled="!mledTimerEnabled"
                />
                <label class="module-label" style="margin-left: 1rem;">Color</label>
                <select v-model="mledDownColor" class="mled-select" :disabled="!mledTimerEnabled">
                  <option value="Red">Red</option>
                  <option value="Green">Green</option>
                  <option value="Blue">Blue</option>
                  <option value="Yellow">Yellow</option>
                  <option value="Magenta">Magenta</option>
                  <option value="Cyan">Cyan</option>
                  <option value="White">White</option>
                  <option value="Orange">Orange</option>
                  <option value="Deep pink">Deep pink</option>
                  <option value="Light Blue">Light Blue</option>
                </select>
              </div>
              <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                <button @click="startCountDown" class="btn btn-primary" :disabled="!mledTimerEnabled">Start</button>
                <button @click="stopCountDown" class="btn btn-danger" :disabled="!mledTimerEnabled">Stop</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Timer LINK Module -->
        <div class="mled-module" :class="{ disabled: !mledLinkEnabled }">
          <div class="module-toggle">
            <label>
              <input type="checkbox" v-model="mledLinkEnabled" :disabled="!mledConnected" />
              Enable
            </label>
          </div>
          <div class="module-header">Timer LINK</div>

          <div style="padding: 1rem;">
            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
              <label class="module-label" style="width: 140px;">Color:</label>
              <select v-model="mledLinkColor" class="mled-select" :disabled="!mledLinkEnabled">
                <option value="Red">Red</option>
                <option value="Green">Green</option>
                <option value="Blue">Blue</option>
                <option value="Yellow">Yellow</option>
                <option value="Magenta">Magenta</option>
                <option value="Cyan">Cyan</option>
                <option value="White">White</option>
                <option value="Orange">Orange</option>
                <option value="Deep pink">Deep pink</option>
                <option value="Light Blue">Light Blue</option>
              </select>
            </div>

            <div class="module-section-container">
              <label class="module-section-label">Status:</label>
              <div class="module-section-text">
                {{ mledLinkStatus }}
              </div>
            </div>
          </div>
        </div>

        <!-- Data Integrator Module -->
        <div class="mled-module" :class="{ disabled: !mledDataEnabled }">
          <div class="module-toggle">
            <label>
              <input type="checkbox" v-model="mledDataEnabled" :disabled="!mledConnected" />
              Enable
            </label>
          </div>
          <div class="module-header">DATA INTEGRATOR</div>

          <div style="padding: 1rem;">
            <div class="module-section-container">
              <label class="module-label" style="display: block; margin-bottom: 0.5rem;">JSON URL:</label>
              <input
                v-model="mledDataUrl"
                type="text"
                placeholder="https://www.smarteragilitysecretary.com/api/ring-jumbotron?key=...&token=..."
                class="mled-select"
                style="width: 100%; font-size: 0.85rem;"
                :disabled="!mledDataEnabled"
              />
              <small style="color: #888; font-size: 0.75rem; display: block; margin-top: 0.25rem;">
                Paste full smarteragilitysecretary.com URL - will be auto-proxied to avoid CORS
              </small>
              <div style="display: flex; margin-top: 0.5rem;">
                <button @click="toggleMledDataAutoUpdate" class="btn" :class="mledDataAutoUpdate ? 'btn-danger' : 'btn-primary'" style="width: 100%;" :disabled="!mledDataEnabled || !mledDataUrl">
                  {{ mledDataAutoUpdate ? 'Stop Auto-Update' : 'Start Auto-Update' }}
                </button>
              </div>

              <div class="module-section-label" style="font-size: 0.85rem; margin-top: 1rem;">
                {{ mledDataStatus }}
              </div>
            </div>
          </div>
        </div>

        <!-- HDMI Module -->
        <div class="mled-module" :class="{ disabled: !hdmiEnabled }">
          <div class="module-toggle">
            <label>
              <input type="checkbox" v-model="hdmiEnabled" />
              Enable
            </label>
          </div>
          <div class="module-header">HDMI</div>

          <div style="padding: 1rem;">
            <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem;">
              <button @click="openHdmiWindow" class="btn btn-primary" :disabled="!hdmiEnabled">
                <i class="material-icons">open_in_new</i>
                Open output
              </button>
              <button @click="fullscreenHdmi" class="btn btn-secondary" :disabled="!hdmiEnabled">
                <i class="material-icons">fullscreen</i>
                Fullscreen
              </button>
            </div>

            <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem;">
              <label class="module-label">Background</label>
              <select v-model="hdmiBackgroundColor" class="mled-select" :disabled="!hdmiEnabled" @change="applyHdmiStyles">
                <option value="#000000">Black</option>
                <option value="#111111">Dark gray</option>
                <option value="#ffffff">White</option>
                <option value="#ef4444">Red</option>
                <option value="#22c55e">Green</option>
                <option value="#3b82f6">Blue</option>
                <option value="#fde047">Yellow</option>
                <option value="#22d3ee">Cyan</option>
                <option value="#f472b6">Rose</option>
              </select>

              <label class="module-label" style="margin-left: 1rem;">Font color</label>
              <select v-model="hdmiForegroundColor" class="mled-select" :disabled="!hdmiEnabled" @change="applyHdmiStyles">
                <option value="#ffffff">White</option>
                <option value="#e5e7eb">Off-white</option>
                <option value="#000000">Black</option>
                <option value="#ef4444">Red</option>
                <option value="#22c55e">Green</option>
                <option value="#3b82f6">Blue</option>
                <option value="#fde047">Yellow</option>
                <option value="#22d3ee">Cyan</option>
                <option value="#fb923c">Orange</option>
                <option value="#60a5fa">Sky</option>
                <option value="#a78bfa">Purple</option>
              </select>

              <label class="module-label" style="margin-left: 1rem;">Font size</label>
              <select v-model="hdmiFontSize" class="mled-select" :disabled="!hdmiEnabled" @change="applyHdmiStyles">
                <option value="64px">64 px</option>
                <option value="80px">80 px</option>
                <option value="96px">96 px</option>
                <option value="120px">120 px</option>
                <option value="160px">160 px</option>
                <option value="180px">180 px</option>
                <option value="200px">200 px</option>
                <option value="240px">240 px</option>
                <option value="280px">280 px</option>
                <option value="320px">320 px</option>
              </select>
            </div>

            <div style="margin-bottom: 1rem;">
              <small style="color: var(--text-secondary); font-size: 0.85rem;">
                Displays content from line 7 (Coursewalk, Countdown, Timer LINK, MLED Text)
              </small>
            </div>

            <div class="module-section-container" :style="{ background: hdmiBackgroundColor }">
              <div :style="{
                color: hdmiForegroundColor,
                fontSize: '32px',
                fontFamily: 'Helvetica, Arial, sans-serif',
                whiteSpace: 'nowrap',
                letterSpacing: '1px',
                textAlign: 'center',
                padding: '1rem',
                overflowX: 'auto'
              }">{{ hdmiPreviewText }}</div>
            </div>
          </div>
        </div>
      </div>
      </div><!-- Close app-content-wrapper -->

      <!-- Debug Console -->
      <div v-if="showDebugConsole" class="debug-console">
        <div class="debug-header">
          <h3>Debug Console</h3>
          <button @click="clearDebugConsole" class="btn btn-small">
            Clear
          </button>
        </div>
        <div class="debug-content">
          <div class="debug-section">
            <h4>Test Runner:</h4>
            <div class="test-controls">
              <button
                @click="startTestRuns"
                :disabled="testRunning"
                class="btn btn-small btn-primary"
              >
                Start Test Runs
              </button>
              <button
                @click="stopTestRuns"
                :disabled="!testRunning"
                class="btn btn-small btn-danger"
              >
                Stop Test Runs
              </button>
              <button
                @click="simulateRTTestRun"
                :disabled="isRunning"
                class="btn btn-small btn-secondary"
              >
                Test RT Signal
              </button>
              <button
                @click="simulateLongTimeTest"
                :disabled="isRunning"
                class="btn btn-small btn-secondary"
              >
                Test Long Time (>1min)
              </button>
              <span class="test-status"
                >{{ testRunning ? 'Running automated tests...' : 'Test runner stopped' }}</span
              >
            </div>
          </div>
          <div class="debug-section">
            <h4>Raw Data Buffer (last 1000 chars):</h4>
            <pre>{{ rawDataBuffer || 'No data received yet...' }}</pre>
          </div>
          <div class="debug-section">
            <h4>Debug Messages:</h4>
            <div class="debug-messages">
              <div
                v-for="(msg, index) in debugMessages"
                :key="index"
                class="debug-message"
              >
                {{ msg }}
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Connection Lost Modal -->
      <div v-if="showConnectionLostModal" class="modal-backdrop">
        <div class="modal confirmation-modal" @click.stop>
          <h2>Connection Lost</h2>
          <p>
            The connection to your timing device has been lost. This usually
            happens when the device is unplugged or there's a communication
            error.
          </p>
          <div class="modal-buttons">
            <button @click="reconnectDevice" class="btn btn-primary">
              <i class="material-icons">usb</i>
              Reconnect
            </button>
            <button
              @click="showConnectionLostModal = false"
              class="btn btn-secondary"
            >
              Close
            </button>
          </div>
        </div>
      </div>

      <!-- Clear Results Confirmation Modal -->
      <div
        v-if="showClearConfirmation"
        class="modal-backdrop"
        @click="cancelClearResults"
      >
        <div class="modal confirmation-modal" @click.stop>
          <h2>Clear Results</h2>
          <p>
            Are you sure you want to clear all results? This action cannot be
            undone.
          </p>
          <div class="modal-buttons">
            <button @click="clearResults" class="btn btn-danger">
              Clear All Results
            </button>
            <button @click="cancelClearResults" class="btn btn-secondary">
              Cancel
            </button>
          </div>
        </div>
      </div>

      <!-- Refresh Confirmation Modal -->
      <div
        v-if="showRefreshConfirmation"
        class="modal-backdrop"
        @click="cancelRefresh"
      >
        <div class="modal confirmation-modal" @click.stop>
          <h2>Refresh Page</h2>
          <p v-if="isRunning">
            <strong>Warning:</strong> The timer is currently running. Refreshing
            will stop the current run and the time will be lost.
          </p>
          <p v-else>
            Are you sure you want to refresh the page? Any unsaved changes will
            be lost.
          </p>
          <div class="modal-buttons">
            <button @click="refreshPage" class="btn btn-danger">
              {{ isRunning ? 'Stop Timer & Refresh' : 'Refresh Page' }}
            </button>
            <button @click="cancelRefresh" class="btn btn-secondary">
              Cancel
            </button>
          </div>
        </div>
      </div>

      <!-- Settings Modal -->
      <div v-if="showSettings" class="modal-backdrop" @click="cancelSettings">
        <div class="modal settings-modal" @click.stop>
          <h2>Settings</h2>

          <!-- <div class="settings-section">
            <h3>Competition Settings</h3>
            <div class="form-group">
              <label for="competitionId">Competition ID</label>
              <input
                type="text"
                id="competitionId"
                v-model="tempSettings.competitionId"
                class="form-control"
                placeholder="Enter competition ID (min 6 alphanumeric characters)"
                maxlength="20"
                @input="validateCompetitionId"
              />
              <small class="form-help">
                Competition ID must be at least 6 characters long and contain
                only letters and numbers. This enables access to XML endpoint at
                /[competition_id]/xml
              </small>
              <div v-if="competitionIdError" class="form-error">
                {{ competitionIdError }}
              </div>
            </div>
          </div> -->

          <div class="settings-section">
            <h3>API Integration</h3>
            <div class="form-group">
              <label class="checkbox-label">
                <input type="checkbox" v-model="tempSettings.apiEnabled" />
                Enable API Integration
              </label>
            </div>

            <div v-if="tempSettings.apiEnabled" class="api-settings">
              <div class="form-group">
                <label for="apiProvider">API Provider</label>
                <select
                  id="apiProvider"
                  v-model="tempSettings.apiProvider"
                  class="form-control"
                  @change="updateApiEndpoint"
                >
                  <option value="agigames">agigames.cz</option>
                  <option value="other">Other (Custom URL)</option>
                </select>
              </div>

              <div class="form-group">
                <label for="apiEndpoint">API Endpoint URL</label>
                <input
                  type="text"
                  id="apiEndpoint"
                  v-model="tempSettings.apiEndpoint"
                  class="form-control"
                  :placeholder="tempSettings.apiProvider === 'agigames' ? 'URL will be auto-generated' : 'https://example.com/api?apikey=[key]&time=[time_no_decimal]&status=[status]'"
                  :readonly="tempSettings.apiProvider === 'agigames'"
                  :class="{ 'readonly': tempSettings.apiProvider === 'agigames' }"
                />
                <small class="form-help">
                  <span v-if="tempSettings.apiProvider === 'agigames'">
                    Using agigames.cz preset with parameters:
                    <strong>[key]</strong>, <strong>[status]</strong>,
                    <strong>[time_no_decimal]</strong>,
                    <strong>[decimals]</strong>
                  </span>
                  <span v-else>
                    You can use placeholders: <strong>[key]</strong>,
                    <strong>[time]</strong>, <strong>[time_no_decimal]</strong>,
                    <strong>[decimals]</strong>, <strong>[status]</strong>,
                    <strong>[timestamp]</strong>
                  </span>
                </small>
              </div>

              <div class="form-group">
                <label for="apiMethod">HTTP Method</label>
                <select
                  id="apiMethod"
                  v-model="tempSettings.apiMethod"
                  class="form-control"
                >
                  <option value="POST">POST</option>
                </select>
              </div>

              <div class="form-group">
                <label for="apiKey">API Key</label>
                <div style="position: relative">
                  <input
                    :type="showApiKey ? 'text' : 'password'"
                    id="apiKey"
                    v-model="tempSettings.apiKey"
                    class="form-control"
                    placeholder="Enter your API key"
                    style="padding-right: 40px"
                  />
                  <button
                    type="button"
                    @click="showApiKey = !showApiKey"
                    style="
                      position: absolute;
                      right: 10px;
                      top: 50%;
                      transform: translateY(-50%);
                      background: transparent;
                      border: none;
                      cursor: pointer;
                      padding: 5px;
                    "
                  >
                    <span v-if="showApiKey">üôà</span>
                    <span v-else>üëÅÔ∏è</span>
                  </button>
                </div>
              </div>

              <div class="form-group">
                <button
                  @click="testApiConnection"
                  class="btn btn-secondary"
                  :disabled="!tempSettings.apiEndpoint || apiTestInProgress"
                >
                  <i class="material-icons"
                    >{{ apiTestInProgress ? 'hourglass_empty' : 'wifi_tethering'
                    }}</i
                  >
                  {{ apiTestInProgress ? 'Testing...' : 'Test Connection' }}
                </button>
                <span
                  v-if="apiTestResult"
                  class="api-test-result"
                  :class="{ 'success': apiTestResult.success, 'error': !apiTestResult.success }"
                >
                  {{ apiTestResult.message }}
                </span>
              </div>

              <h4>Status Code Mapping</h4>
              <div class="form-group">
                <div style="display: flex; align-items: center; gap: 10px">
                  <input
                    type="checkbox"
                    id="enableStartedApi"
                    v-model="tempSettings.apiStartedEnabled"
                    class="form-control"
                    style="width: auto"
                  />
                  <label for="enableStartedApi" style="margin: 0"
                    >Timer Started (Dog begins)</label
                  >
                </div>
                <input
                  type="number"
                  id="statusStarted"
                  v-model="tempSettings.statusMappings.started"
                  class="form-control"
                  placeholder="3"
                  :disabled="!tempSettings.apiStartedEnabled"
                />
              </div>

              <div class="form-group">
                <div style="display: flex; align-items: center; gap: 10px">
                  <input
                    type="checkbox"
                    id="enableFinishedApi"
                    v-model="tempSettings.apiFinishedEnabled"
                    class="form-control"
                    style="width: auto"
                  />
                  <label for="enableFinishedApi" style="margin: 0"
                    >Timer Finished (Result)</label
                  >
                </div>
                <input
                  type="number"
                  id="statusFinished"
                  v-model="tempSettings.statusMappings.finished"
                  class="form-control"
                  placeholder="4"
                  :disabled="!tempSettings.apiFinishedEnabled"
                />
              </div>
            </div>
          </div>

          <div class="modal-buttons">
            <button @click="saveSettings" class="btn btn-primary">
              Save Settings
            </button>
            <button @click="cancelSettings" class="btn btn-secondary">
              Cancel
            </button>
          </div>
        </div>
      </div>

      <!-- Info Modal -->
      <div v-if="showInfo" class="modal-backdrop" @click="cancelInfo">
        <div class="modal info-modal" @click.stop>
          <h1>Agility Timer Online - Quick Guide</h1>

          <h2>Supported browsers and timers</h2>
          <p>
            This app works on Chrome and Edge. Supported timers are FDS T-BOX
            and ALGE TDC8001. TIMY3 support coming soon. FDS T-BOX may require
            Windows drivers: you can download them from
            <a href="https://fdstiming.com/download/"
              >https://fdstiming.com/download/</a
            >. ALGE Timy requires Windows drivers:
            <a
              href="https://alge-timing.com/alge/download/driver/TimyUSBDriver.exe"
              >download here</a
            >.
          </p>

          <div class="important-notice">
            <strong>Important:</strong> When using Agility Timer Online, please
            disable power saving features on your computer. If the computer goes
            to sleep, all connected USB devices (including the timer) will be
            disconnected.
            <ul>
              <li>disable sleep mode</li>
              <li>do not allow USB ports to power down</li>
              <li>disable hard disk sleep</li>
              <li>set the power plan to High Performance</li>
            </ul>
            <div>
              <strong>Windows:</strong> Control Panel ‚Üí Power Options ‚Üí Change
              plan settings ‚Üí set Sleep to Never. In Device Manager, under USB
              controllers, uncheck "Allow the computer to turn off this device
              to save power".
            </div>
            <div>
              <strong>macOS:</strong> System Settings ‚Üí Battery ‚Üí disable
              computer sleep when plugged in. Enable the option to prevent
              automatic sleep when the display is off.
            </div>
            <div>
              <strong>Physical Disconnection:</strong> If you physically unplug
              the USB device, the browser removes it from authorized devices.
              Auto-reconnection will try to reconnect, but if it fails, you'll
              need to click the "Connect" button to re-authorize the device.
            </div>
          </div>

          <h2>What it does</h2>
          <p>
            Agility Timer Online connects to your timing device and shows live
            run times for agility training or competitions. You can save
            results, export them, or send them to another system using the API.
          </p>

          <h2>How to use</h2>
          <ol>
            <li>
              <strong>Connect to the timer</strong> - Connect using a USB cable
              or a USB/serial adapter, then click <em>Connect</em> to link with
              your device. For FDS T-BOX, make sure the device is set to the
              ALGE protocol and autotiming mode. The status light will turn
              green when connected.
            </li>
            <li>
              <strong>Start and view results</strong> - The timer will start
              automatically when the device sends a start signal. The current
              time appears in the main display.
            </li>
            <li>
              <strong>Copy results</strong> - Double-click the time or use the
              <em>Copy</em> button to copy it. In the history table, click a row
              to select it, then use <em>Copy Selected</em>.
            </li>
            <li>
              <strong>Export or clear results</strong> - Use
              <em>Export CSV</em> to save all results as a file. Use
              <em>Clear Results</em> to remove them (confirmation required).
            </li>
            <li>
              <strong>Set precision</strong> - Enable <em>High Precision</em> to
              show milliseconds.
            </li>
            <li>
              <strong>Settings</strong> - Open <em>Settings</em> to set up API
              integration. You can enter an endpoint, method, key, and map
              status codes for start and finish events.
            </li>
            <li>
              <strong>Debug mode</strong> - Click the bug/code button in the
              corner to open the debug console for test runs and raw data view.
            </li>
          </ol>

          <div class="integration-section">
            <h2>Integration with agigames.cz</h2>
            <p>
              If you want to integrate with <strong>agigames.cz</strong>, open
              the <em>Settings</em> tab, activate the API, and select
              "agigames.cz" from the provider dropdown.
            </p>
            <p>
              The URL will be auto-configured as:
              <code
                >https://new.agigames.cz/api/api_timer.php?apikey=[key]&status=[status]&time=[time_no_decimal]&dec=[decimals]</code
              >
            </p>
            <p>You also need to request a free API key from agigames.cz.</p>
          </div>

          <div class="modal-buttons">
            <button @click="cancelInfo" class="btn btn-primary">Close</button>
          </div>
        </div>
      </div>

      <!-- Compact Timer Modal -->
      <div v-if="showCompactTimer" class="modal-backdrop" @click="closeCompactTimer">
        <div class="modal compact-timer-modal" @click.stop>
          <h2>Latest Result</h2>
          <div
            class="compact-timer-display"
            :class="{ running: isRunning }"
            @dblclick="copyLatestResult"
            title="Double-click to copy"
          >
            <div class="compact-timer-value">{{ displayTime }}</div>
            <div class="compact-timer-status">{{ timerStatus }}</div>
          </div>
          <div class="modal-buttons">
            <button
              @click="copyLatestResult"
              class="btn btn-primary"
              :class="{ 'copy-success': copyButtonEffect === 'latest' }"
            >
              <i class="material-icons"
                >{{ copyButtonEffect === 'latest' ? 'check' : 'content_copy'
                }}</i
              >
              {{ copyButtonEffect === 'latest' ? 'Copied!' : 'Copy' }}
            </button>
            <button @click="closeCompactTimer" class="btn btn-secondary">
              Close
            </button>
          </div>
        </div>
      </div>

      <!-- Debug Toggle Button -->
      <button
        @click="toggleDebugConsole"
        class="debug-toggle"
        :class="{ active: showDebugConsole }"
        title="Toggle Debug Console"
      >
        <i class="material-icons"
          >{{ showDebugConsole ? 'bug_report' : 'code' }}</i
        >
      </button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.js"></script>
    <script src="assets/js/app.js"></script>
  </body>
</html>
