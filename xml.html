<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timer XML Endpoint</title>
</head>
<body>
    <script>
        // XML Endpoint Handler
        (function() {
            function checkXmlEndpoint() {
                const path = window.location.pathname;
                const xmlMatch = path.match(/^\/([a-zA-Z0-9]{6,})\/xml\/?$/);
                
                if (xmlMatch) {
                    const competitionId = xmlMatch[1];
                    handleXmlRequest(competitionId);
                    return true;
                }
                return false;
            }
            
            function handleXmlRequest(competitionId) {
                // Load saved settings to get competition ID
                const savedSettings = localStorage.getItem('timerSettings');
                let settings = {};
                if (savedSettings) {
                    try {
                        settings = JSON.parse(savedSettings);
                    } catch (error) {
                        renderXmlError('Settings format error');
                        return;
                    }
                }
                
                // Check if competition ID matches
                if (settings.competitionId !== competitionId) {
                    renderXmlError('Competition ID not found or not configured');
                    return;
                }
                
                // Load results from localStorage
                const savedResults = localStorage.getItem('timerResults');
                let results = [];
                if (savedResults) {
                    try {
                        results = JSON.parse(savedResults);
                    } catch (error) {
                        console.error('Error loading saved results:', error);
                    }
                }
                
                // Get current timer state from localStorage
                const timerRunning = localStorage.getItem('timerRunning');
                const isRunning = timerRunning === 'true';
                const displayTime = results.length > 0 ? results[0].time : '0.00';
                
                renderXml(displayTime, isRunning);
            }
            
            function renderXml(time, running) {
                const runningValue = running ? '1' : '0';
                const xmlContent = `<?xml version="1.0" encoding="UTF-8"?>
<timer>
    <time>${time}</time>
    <running>${runningValue}</running>
</timer>`;
                
                // Set content type and replace document
                document.open();
                document.write(xmlContent);
                document.close();
                
                // Try to set the content type
                try {
                    document.contentType = 'application/xml';
                } catch (e) {
                    // Fallback: add meta tag
                    const meta = document.createElement('meta');
                    meta.httpEquiv = 'Content-Type';
                    meta.content = 'application/xml; charset=utf-8';
                    if (document.head) {
                        document.head.appendChild(meta);
                    }
                }
            }
            
            function renderXmlError(errorMessage) {
                const xmlContent = `<?xml version="1.0" encoding="UTF-8"?>
<error>
    <message>${errorMessage}</message>
</error>`;
                
                document.open();
                document.write(xmlContent);
                document.close();
            }
            
            // Check if this is an XML endpoint request
            if (!checkXmlEndpoint()) {
                // If not an XML request, redirect to main app
                window.location.href = '/timer.html';
            }
        })();
    </script>
</body>
</html>